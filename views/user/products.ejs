<!DOCTYPE html>
<html lang="en">

<head>
    <title>
        <%= title %> - Hien Bakery Shop
    </title>
    <%- include('../partials/user/head') %>
</head>

<body class="goto-here">
    <%- include('../partials/user/header') %>

        <div class="hero-wrap hero-bread" style="background-image: url('/images/slideshow_6.png');">
            <div class="container">
                <div class="row no-gutters slider-text align-items-center justify-content-center">
                    <div class="col-md-9 ftco-animate text-center">
                        <p class="breadcrumbs">
                            <span class="mr-2"><a href="/">Trang chủ</a></span>
                            <span>Sản phẩm</span>
                        </p>
                        <h1 class="mb-0 bread">
                            <%= title %>
                        </h1>
                    </div>
                </div>
            </div>
        </div>

        <section class="ftco-section">
            <div class="container">
                <div class="row">
                    <!-- Sidebar Filter -->
                    <div class="col-lg-3 sidebar">
                        <!-- Search Box -->
                        <div class="sidebar-box mb-4">
                            <form action="/products/search" method="GET" class="search-form">
                                <div class="form-group">
                                    <span class="icon ion-ios-search"></span>
                                    <input type="text" name="keyword" class="form-control"
                                        placeholder="Tìm kiếm sản phẩm..."
                                        value="<%= typeof keyword !== 'undefined' ? keyword : '' %>">
                                </div>
                            </form>
                        </div>

                        <!-- Category Filter -->
                        <div class="sidebar-box-2">
                            <h2 class="heading mb-4">Danh mục</h2>
                            <ul>
                                <li>
                                    <a href="/products"
                                        class="<%= typeof selectedCategory === 'undefined' || !selectedCategory ? 'active' : '' %>">
                                        Tất cả sản phẩm
                                        <span>(<%= totalProducts %>)</span>
                                    </a>
                                </li>
                                <% if (categories && categories.length> 0) { %>
                                    <% categories.forEach(cat=> { %>
                                        <li>
                                            <a href="/products/category/<%= cat._id %>"
                                                class="<%= selectedCategory == cat._id ? 'active' : '' %>">
                                                <%= cat.name %>
                                            </a>
                                        </li>
                                        <% }) %>
                                            <% } %>
                            </ul>
                        </div>

                        <!-- Sort Filter -->
                        <div class="sidebar-box-2 mt-4">
                            <h2 class="heading mb-4">Sắp xếp</h2>
                            <form action="/products" method="GET" id="sortForm">
                                <% if (selectedCategory) { %>
                                    <input type="hidden" name="category" value="<%= selectedCategory %>">
                                    <% } %>
                                        <select name="sort" class="form-control"
                                            onchange="document.getElementById('sortForm').submit()">
                                            <option value="newest" <%=selectedSort==='newest' ? 'selected' : '' %>>Mới
                                                nhất</option>
                                            <option value="price_asc" <%=selectedSort==='price_asc' ? 'selected' : '' %>
                                                >Giá tăng dần</option>
                                            <option value="price_desc" <%=selectedSort==='price_desc' ? 'selected' : ''
                                                %>>Giá giảm dần</option>
                                            <option value="name_asc" <%=selectedSort==='name_asc' ? 'selected' : '' %>
                                                >Tên A-Z</option>
                                            <option value="name_desc" <%=selectedSort==='name_desc' ? 'selected' : '' %>
                                                >Tên Z-A</option>
                                        </select>
                            </form>
                        </div>
                    </div>

                    <!-- Products List -->
                    <div class="col-lg-9">
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <p class="text-muted">
                                        Hiển thị <%= products.length %> trên tổng <%= totalProducts %> sản phẩm
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <% if (products && products.length> 0) { %>
                                <% products.forEach(product=> { %>
                                    <div class="col-md-6 col-lg-4 ftco-animate">
                                        <div class="product">
                                            <a href="/products/<%= product._id %>" class="img-prod">
                                                <% if (product.images && product.images.length> 0) { %>
                                                    <img class="img-fluid"
                                                        src="/uploads/products/<%= product.images[0] %>"
                                                        alt="<%= product.name %>"
                                                        style="height: 300px; object-fit: cover;">
                                                    <% } else { %>
                                                        <img class="img-fluid" src="/images/no-image.jpg"
                                                            alt="No image">
                                                        <% } %>
                                                            <div class="overlay"></div>
                                            </a>
                                            <div class="text py-3 pb-4 px-3 text-center">
                                                <h3><a href="/products/<%= product._id %>">
                                                        <%= product.name %>
                                                    </a></h3>

                                                <% if (product.size) { %>
                                                    <p class="text-muted small mb-2">Kích thước: <%= product.size %>
                                                    </p>
                                                    <% } %>

                                                        <div class="d-flex">
                                                            <div class="pricing">
                                                                <p class="price">
                                                                    <span>
                                                                        <%= product.price.toLocaleString('vi-VN') %>₫
                                                                    </span>
                                                                </p>
                                                            </div>
                                                        </div>

                                                        <div class="bottom-area d-flex px-3">
                                                            <div class="m-auto d-flex">
                                                                <a href="/products/<%= product._id %>"
                                                                    class="add-to-cart d-flex justify-content-center align-items-center text-center"
                                                                    title="Xem chi tiết">
                                                                    <span><i class="ion-ios-menu"></i></span>
                                                                </a>
                                                                <a href="javascript:void(0);"
                                                                    onclick="addToCart('<%= product._id %>')"
                                                                    class="buy-now d-flex justify-content-center align-items-center mx-1"
                                                                    title="Thêm vào giỏ">
                                                                    <span><i class="ion-ios-cart"></i></span>
                                                                </a>
                                                                <a href="javascript:void(0);"
                                                                    onclick="addToWishlist('<%= product._id %>')"
                                                                    class="heart d-flex justify-content-center align-items-center"
                                                                    title="Yêu thích">
                                                                    <span><i class="ion-ios-heart"></i></span>
                                                                </a>
                                                            </div>
                                                        </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% }) %>
                                        <% } else { %>
                                            <div class="col-12 text-center py-5">
                                                <img src="/images/empty-box.png" alt="Không có sản phẩm"
                                                    style="width: 200px; opacity: 0.5;">
                                                <p class="text-muted mt-3">
                                                    <% if (typeof keyword !=='undefined' && keyword) { %>
                                                        Không tìm thấy sản phẩm nào với từ khóa "<%= keyword %>"
                                                            <% } else { %>
                                                                Chưa có sản phẩm nào
                                                                <% } %>
                                                </p>
                                            </div>
                                            <% } %>
                        </div>

                        <!-- Pagination -->
                        <% if (totalPages> 1) { %>
                            <div class="row mt-5">
                                <div class="col text-center">
                                    <div class="block-27">
                                        <ul>
                                            <!-- Previous Button -->
                                            <% if (currentPage> 1) { %>
                                                <li>
                                                    <a
                                                        href="?page=<%= currentPage - 1 %><%= selectedCategory ? '&category=' + selectedCategory : '' %><%= selectedSort ? '&sort=' + selectedSort : '' %>">&lt;</a>
                                                </li>
                                                <% } else { %>
                                                    <li class="disabled"><span>&lt;</span></li>
                                                    <% } %>

                                                        <!-- Page Numbers -->
                                                        <% let startPage=Math.max(1, currentPage - 2); let
                                                            endPage=Math.min(totalPages, currentPage + 2); %>

                                                            <% if (startPage> 1) { %>
                                                                <li><a
                                                                        href="?page=1<%= selectedCategory ? '&category=' + selectedCategory : '' %><%= selectedSort ? '&sort=' + selectedSort : '' %>">1</a>
                                                                </li>
                                                                <% if (startPage> 2) { %>
                                                                    <li class="disabled"><span>...</span></li>
                                                                    <% } %>
                                                                        <% } %>

                                                                            <% for (let i=startPage; i <=endPage; i++) {
                                                                                %>
                                                                                <li
                                                                                    class="<%= i === currentPage ? 'active' : '' %>">
                                                                                    <a
                                                                                        href="?page=<%= i %><%= selectedCategory ? '&category=' + selectedCategory : '' %><%= selectedSort ? '&sort=' + selectedSort : '' %>">
                                                                                        <%= i %>
                                                                                    </a>
                                                                                </li>
                                                                                <% } %>

                                                                                    <% if (endPage < totalPages) { %>
                                                                                        <% if (endPage < totalPages - 1)
                                                                                            { %>
                                                                                            <li class="disabled">
                                                                                                <span>...</span>
                                                                                            </li>
                                                                                            <% } %>
                                                                                                <li><a
                                                                                                        href="?page=<%= totalPages %><%= selectedCategory ? '&category=' + selectedCategory : '' %><%= selectedSort ? '&sort=' + selectedSort : '' %>">
                                                                                                        <%= totalPages
                                                                                                            %>
                                                                                                    </a></li>
                                                                                                <% } %>

                                                                                                    <!-- Next Button -->
                                                                                                    <% if (currentPage <
                                                                                                        totalPages) { %>
                                                                                                        <li>
                                                                                                            <a
                                                                                                                href="?page=<%= currentPage + 1 %><%= selectedCategory ? '&category=' + selectedCategory : '' %><%= selectedSort ? '&sort=' + selectedSort : '' %>">&gt;</a>
                                                                                                        </li>
                                                                                                        <% } else { %>
                                                                                                            <li
                                                                                                                class="disabled">
                                                                                                                <span>&gt;</span>
                                                                                                            </li>
                                                                                                            <% } %>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                    </div>
                </div>
            </div>
        </section>

        <%- include('../partials/user/footer') %>
            <%- include('../partials/user/load') %>
                <%- include('../partials/user/scripts') %>

                    <script>
                        // Thêm vào giỏ hàng
                        function addToCart(productId) {
                            fetch('/cart/add', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    productId: productId,
                                    quantity: 1
                                })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        document.getElementById('cart-count').textContent = data.cartCount;
                                        showNotification('success', data.message);
                                    } else {
                                        showNotification('error', data.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showNotification('error', 'Có lỗi xảy ra!');
                                });
                        }

                        // Thêm vào yêu thích
                        function addToWishlist(productId) {
                            fetch('/wishlist/add', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ productId: productId })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        document.getElementById('wishlist-count').textContent = data.wishlistCount;
                                        showNotification('success', data.message);
                                    } else {
                                        showNotification('error', data.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showNotification('error', 'Có lỗi xảy ra!');
                                });
                        }

                        // Hiển thị thông báo
                        function showNotification(type, message) {
                            const notification = document.createElement('div');
                            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} notification-popup`;
                            notification.innerHTML = `
                <strong>${type === 'success' ? 'Thành công' : 'Thất bại'}</strong> ${message}
            `;

                            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease-out;
            `;

                            document.body.appendChild(notification);

                            setTimeout(() => {
                                notification.style.animation = 'slideOutRight 0.3s ease-out';
                                setTimeout(() => notification.remove(), 300);
                            }, 3000);
                        }
                    </script>

                    <style>
                        .sidebar-box-2 ul li a.active {
                            color: #82ae46;
                            font-weight: bold;
                        }

                        @keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }

                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }

                        @keyframes slideOutRight {
                            from {
                                transform: translateX(0);
                                opacity: 1;
                            }

                            to {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                        }
                    </style>
</body>

</html>