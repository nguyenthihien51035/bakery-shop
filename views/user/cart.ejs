<!DOCTYPE html>
<html lang="en">

<head>
	<title>Hien Bakery Shop</title>
	<%- include('../partials/user/head') %>
</head>

<body class="goto-here">
	<%- include('../partials/user/header') %>

		<div class="hero-wrap hero-bread" style="background-image: url('images/banner_img3.jpg');">
			<div class="container">
				<div class="row no-gutters slider-text align-items-center justify-content-center">
					<div class="col-md-9 ftco-animate text-center">
						<p class="breadcrumbs"><span class="mr-2 font-weight-bold"><a href="/">Trang chủ /</a></span>
							<span class="font-weight-bold">Giỏ hàng</span>
						</p>
						<h1 class="mb-0 bread">Giỏ hàng của tôi</h1>
					</div>
				</div>
			</div>
		</div>

		<section class="ftco-section ftco-cart">
			<div class="container">
				<div class="row">
					<div class="col-md-12 ftco-animate">
						<div class="cart-list">
							<table class="table">
								<thead class="thead-primary">
									<tr class="text-center">
										<th>&nbsp;</th>
										<th>Hình ảnh</th>
										<th>Tên sản phẩm</th>
										<th>Giá</th>
										<th>Số lượng</th>
										<th>Tổng</th>
									</tr>
								</thead>
								<tbody>
									<% if (cartItems && cartItems.length> 0) { %>
										<% cartItems.forEach(item=> { %>
											<tr class="text-center">
												<td class="product-remove">
													<a href="javascript:void(0);"
														onclick="removeFromCart('<%= item.productId %>')">
														<span class="ion-ios-close"></span>
													</a>
												</td>

												<td class="image-prod">
													<% let imageUrl='/images/no-image.jpg' ; if (item.images &&
														item.images.length> 0) {
														imageUrl = '/uploads/products/' + item.images[0];
														}
														%>
														<div class="img"
															style="background-image:url('<%= imageUrl %>');">
														</div>
												</td>

												<td class="product-name">
													<h3>
														<%= item.name %>
													</h3>
													<p>
														<%= item.description ? item.description.substring(0, 80) + '...'
															: '' %>
													</p>
												</td>

												<td class="price">
													<%= item.price.toLocaleString('vi-VN') %>đ
												</td>

												<td class="quantity">
													<div class="input-group mb-3">
														<input type="number" class="quantity form-control input-number"
															value="<%= item.quantity %>" min="1" max="100"
															onchange="updateQuantity('<%= item.productId %>', this.value)">
													</div>
												</td>

												<td class="total" id="item-total-<%= item.productId %>">
													<%= item.total.toLocaleString('vi-VN') %>đ
												</td>
											</tr>
											<% }) %>
												<% } else { %>
													<tr>
														<td colspan="6" class="text-center py-5">
															<img src="/images/empty-cart.png" alt="Empty"
																style="max-width: 200px; opacity: 0.5;">
															<h4 class="mt-3">Giỏ hàng trống</h4>
															<p class="text-muted">Bạn chưa có sản phẩm nào trong giỏ
																hàng</p>
															<a href="/" class="btn btn-primary mt-3">Tiếp tục mua
																sắm</a>
														</td>
													</tr>
													<% } %>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="row justify-content-center">
					<div class="col-lg-12 mt-5 cart-wrap ftco-animate">
						<div class="cart-total mb-3">
							<h3>Tổng giỏ hàng</h3>
							<p class="d-flex">
								<span>Tạm tính</span>
								<span id="cart-subtotal">
									<%= subtotal.toLocaleString('vi-VN') %>đ
								</span>
							</p>
							<p class="d-flex">
								<span>Phí vận chuyển</span>
								<span>
									<%= shipping.toLocaleString('vi-VN') %>đ
								</span>
							</p>
							<p class="d-flex">
								<span>Giảm giá</span>
								<span>
									<%= discount.toLocaleString('vi-VN') %>đ
								</span>
							</p>
							<hr>
							<p class="d-flex total-price">
								<span>Tổng cộng</span>
								<span id="cart-total">
									<%= total.toLocaleString('vi-VN') %>đ
								</span>
							</p>
						</div>
						<% if (cartItems && cartItems.length> 0) { %>
							<p><a href="/checkout" class="btn btn-primary py-3 px-4">Thanh toán</a></p>
							<% } else { %>
								<p><a href="/" class="btn btn-secondary py-3 px-4">Tiếp tục mua sắm</a></p>
								<% } %>
					</div>
				</div>
			</div>
		</section>

		<%- include('../partials/user/load') %>
			<%- include('../partials/user/scripts') %>
				<script>
					// Xóa sản phẩm khỏi giỏ hàng
					function removeFromCart(productId) {
						if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
							return;
						}

						fetch('/cart/remove', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({ productId: productId })
						})
							.then(response => response.json())
							.then(data => {
								if (data.success) {
									document.getElementById('cart-count').textContent = data.cartCount;
									location.reload();
								} else {
									alert(data.message);
								}
							})
							.catch(error => {
								console.error('Error:', error);
								alert('Có lỗi xảy ra!');
							});
					}

					// Cập nhật số lượng
					function updateQuantity(productId, quantity) {
						quantity = parseInt(quantity);

						if (quantity < 1) {
							alert('Số lượng phải lớn hơn 0!');
							location.reload();
							return;
						}

						fetch('/cart/update-quantity', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								productId: productId,
								quantity: quantity
							})
						})
							.then(response => response.json())
							.then(data => {
								if (data.success) {
									// Cập nhật số lượng trên header
									document.getElementById('cart-count').textContent = data.cartCount;

									// Cập nhật tổng tiền của item
									const itemTotal = data.itemTotal; // Backend cần trả về
									const itemTotalElement = document.getElementById('item-total-' + productId);
									if (itemTotalElement && itemTotal !== undefined) {
										itemTotalElement.textContent = itemTotal.toLocaleString('vi-VN') + '₫';
									}

									// Cập nhật tổng giỏ hàng
									if (data.cartSummary) {
										document.getElementById('cart-subtotal').textContent =
											data.cartSummary.subtotal.toLocaleString('vi-VN') + '₫';
										document.getElementById('cart-total').textContent =
											data.cartSummary.total.toLocaleString('vi-VN') + '₫';
									}

									// Hiển thị thông báo (không reload)
									showNotification('success', 'Đã cập nhật số lượng!');
								} else {
									alert(data.message);
								}
							})
							.catch(error => {
								console.error('Error:', error);
								alert('Có lỗi xảy ra!');
							});
					}

					// Thêm hàm hiển thị thông báo
					function showNotification(type, message) {
						const notification = document.createElement('div');
						notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} notification-popup`;
						notification.innerHTML = `<strong>${message}</strong>`;

						notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 250px;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
    `;

						document.body.appendChild(notification);

						setTimeout(() => {
							notification.style.animation = 'slideOutRight 0.3s ease-out';
							setTimeout(() => notification.remove(), 300);
						}, 2000);
					}
				</script>
				<style>
					@keyframes slideInRight {
						from {
							transform: translateX(100%);
							opacity: 0;
						}

						to {
							transform: translateX(0);
							opacity: 1;
						}
					}

					@keyframes slideOutRight {
						from {
							transform: translateX(0);
							opacity: 1;
						}

						to {
							transform: translateX(100%);
							opacity: 0;
						}
					}
				</style>
</body>

</html>