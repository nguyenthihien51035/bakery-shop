<!DOCTYPE html>

<html lang="en" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../assets/"
    data-template="vertical-menu-template-free">

<head>
    <%- include('../partials/admin/head') %>
</head>

<body>
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <%- include('../partials/admin/navbar') %>

                <div class="layout-page">
                    <%- include('../partials/admin/header') %>

                        <div class="content-wrapper">
                            <div class="container-xxl flex-grow-1 container-p-y">
                                <h4 class="fw-bold py-3 mb-4">
                                    <span class="text-muted fw-light">Qu·∫£n l√Ω / S·∫£n ph·∫©m /</span> S·ª≠a s·∫£n ph·∫©m
                                </h4>

                                <!-- Flash Messages -->
                                <% if (typeof success !=='undefined' && success.length> 0) { %>
                                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                                        <strong>Th√†nh c√¥ng!</strong>
                                        <%= success %>
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                    <% } %>
                                        <% if (typeof error !=='undefined' && error.length> 0) { %>
                                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                                <strong>L·ªói!</strong>
                                                <%= error %>
                                                    <button type="button" class="btn-close"
                                                        data-bs-dismiss="alert"></button>
                                            </div>
                                            <% } %>

                                                <form action="/admin/products/edit/<%= product._id %>" method="POST"
                                                    enctype="multipart/form-data" id="editProductForm">
                                                    <div class="row">
                                                        <!-- C·ªôt tr√°i - Form ch√≠nh -->
                                                        <div class="col-md-8">
                                                            <!-- Th√¥ng tin c∆° b·∫£n -->
                                                            <div class="card mb-4">
                                                                <div
                                                                    class="card-header d-flex justify-content-between align-items-center">
                                                                    <h5 class="mb-0"><i
                                                                            class="bx bx-edit me-2"></i>Ch·ªânh s·ª≠a th√¥ng
                                                                        tin</h5>
                                                                    <small class="text-muted">ID: <%= product._id %>
                                                                    </small>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="mb-3">
                                                                        <label class="form-label" for="productName">
                                                                            T√™n s·∫£n ph·∫©m <span
                                                                                class="text-danger">*</span>
                                                                        </label>
                                                                        <input type="text" class="form-control"
                                                                            id="productName" name="name"
                                                                            value="<%= product.name %>" required />
                                                                    </div>

                                                                    <div class="mb-3">
                                                                        <label class="form-label" for="productDesc">
                                                                            M√¥ t·∫£ <span class="text-danger">*</span>
                                                                        </label>
                                                                        <textarea class="form-control" id="productDesc"
                                                                            name="description" rows="6"
                                                                            required><%= product.description || '' %></textarea>
                                                                        <div class="form-text">M√¥ t·∫£ chi ti·∫øt gi√∫p kh√°ch
                                                                            h√†ng hi·ªÉu r√µ h∆°n v·ªÅ s·∫£n ph·∫©m</div>
                                                                    </div>

                                                                    <div class="row">
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label"
                                                                                for="productPrice">
                                                                                Gi√° b√°n <span
                                                                                    class="text-danger">*</span>
                                                                            </label>
                                                                            <div class="input-group">
                                                                                <input type="number"
                                                                                    class="form-control"
                                                                                    id="productPrice" name="price"
                                                                                    min="0" step="1000"
                                                                                    value="<%= product.price %>"
                                                                                    required />
                                                                                <span class="input-group-text">‚Ç´</span>
                                                                            </div>
                                                                        </div>

                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label"
                                                                                for="productSize">K√≠ch th∆∞·ªõc</label>
                                                                            <input type="text" class="form-control"
                                                                                id="productSize" name="size"
                                                                                value="<%= product.size || '' %>"
                                                                                placeholder="VD: 18cm, Nh·ªè (1-2 ng∆∞·ªùi)..." />
                                                                        </div>
                                                                    </div>

                                                                    <div class="mb-3">
                                                                        <label class="form-label" for="productCategory">
                                                                            Danh m·ª•c <span class="text-danger">*</span>
                                                                        </label>
                                                                        <select class="form-select" id="productCategory"
                                                                            name="category" required>
                                                                            <option value="">-- Ch·ªçn danh m·ª•c --
                                                                            </option>
                                                                            <% categories.forEach(category=> { %>
                                                                                <option value="<%= category._id %>"
                                                                                    <%=product.category &&
                                                                                    product.category._id.toString()===category._id.toString()
                                                                                    ? 'selected' : '' %>>
                                                                                    <%= category.name %>
                                                                                </option>
                                                                                <% }) %>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- H√¨nh ·∫£nh hi·ªán t·∫°i -->
                                                            <div class="card mb-4">
                                                                <div class="card-header">
                                                                    <h5 class="mb-0"><i
                                                                            class="bx bx-image me-2"></i>H√¨nh ·∫£nh hi·ªán
                                                                        t·∫°i</h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <% if (product.images && product.images.length> 0) {
                                                                        %>
                                                                        <div class="row g-2">
                                                                            <% product.images.forEach((image, index)=> {
                                                                                %>
                                                                                <div class="col-md-3">
                                                                                    <div class="card position-relative">
                                                                                        <img src="/uploads/products/<%= image %>"
                                                                                            class="card-img-top"
                                                                                            style="height: 150px; object-fit: cover;"
                                                                                            alt="<%= product.name %>" />
                                                                                        <div class="card-body p-2">
                                                                                            <div class="form-check">
                                                                                                <input
                                                                                                    class="form-check-input"
                                                                                                    type="checkbox"
                                                                                                    name="deleteImages"
                                                                                                    value="<%= image %>"
                                                                                                    id="deleteImg<%= index %>">
                                                                                                <label
                                                                                                    class="form-check-label small"
                                                                                                    for="deleteImg<%= index %>">
                                                                                                    <%= index===0
                                                                                                        ? 'üìå ·∫¢nh ch√≠nh'
                                                                                                        : '·∫¢nh ' +
                                                                                                        (index + 1) %>
                                                                                                </label>
                                                                                            </div>
                                                                                        </div>
                                                                                        <span
                                                                                            class="badge bg-danger position-absolute top-0 end-0 m-2">
                                                                                            <i class="bx bx-trash"></i>
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                                <% }) %>
                                                                        </div>
                                                                        <div class="alert alert-info mt-3 mb-0"
                                                                            role="alert">
                                                                            <i class="bx bx-info-circle me-1"></i>
                                                                            T√≠ch ch·ªçn ·∫£nh mu·ªën x√≥a, sau ƒë√≥ nh·∫•n "C·∫≠p
                                                                            nh·∫≠t s·∫£n ph·∫©m"
                                                                        </div>
                                                                        <% } else { %>
                                                                            <div class="alert alert-warning mb-0">
                                                                                <i class="bx bx-error me-1"></i> Ch∆∞a c√≥
                                                                                ·∫£nh n√†o
                                                                            </div>
                                                                            <% } %>
                                                                </div>
                                                            </div>

                                                            <!-- Th√™m ·∫£nh m·ªõi -->
                                                            <div class="card mb-4">
                                                                <div class="card-header">
                                                                    <h5 class="mb-0"><i
                                                                            class="bx bx-image-add me-2"></i>Th√™m ·∫£nh
                                                                        m·ªõi</h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="mb-3">
                                                                        <label class="form-label" for="productImages">
                                                                            T·∫£i l√™n ·∫£nh m·ªõi (n·∫øu c·∫ßn)
                                                                        </label>
                                                                        <input class="form-control" type="file"
                                                                            id="productImages" name="images"
                                                                            accept="image/*" multiple />
                                                                        <div class="form-text">
                                                                            Ch·ªçn nhi·ªÅu ·∫£nh (t·ªëi ƒëa 10 ·∫£nh, m·ªói ·∫£nh t·ªëi
                                                                            ƒëa 5MB)
                                                                        </div>
                                                                    </div>

                                                                    <!-- Preview ·∫£nh m·ªõi -->
                                                                    <div id="imagePreview" class="row g-2"></div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- C·ªôt ph·∫£i - Th√¥ng tin & Tr·∫°ng th√°i -->
                                                        <div class="col-md-4">
                                                            <!-- Tr·∫°ng th√°i -->
                                                            <div class="card mb-3">
                                                                <div class="card-header">
                                                                    <h5 class="mb-0"><i class="bx bx-cog me-2"></i>Tr·∫°ng
                                                                        th√°i</h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="form-check form-switch mb-2">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            name="isActive" id="isActive"
                                                                            <%=product.isActive ? 'checked' : '' %> />
                                                                        <label class="form-check-label" for="isActive">
                                                                            <strong>Hi·ªÉn th·ªã s·∫£n ph·∫©m</strong>
                                                                        </label>
                                                                    </div>
                                                                    <div class="form-text">
                                                                        <i class="bx bx-info-circle"></i>
                                                                        B·∫≠t ƒë·ªÉ hi·ªÉn th·ªã s·∫£n ph·∫©m tr√™n website
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Th√¥ng tin -->
                                                            <div class="card mb-3">
                                                                <div class="card-body">
                                                                    <h5 class="card-title">
                                                                        <i
                                                                            class="bx bx-info-circle text-primary me-1"></i>
                                                                        Th√¥ng tin
                                                                    </h5>
                                                                    <hr>

                                                                    <div class="mb-2">
                                                                        <small class="text-muted d-block">Ng√†y
                                                                            t·∫°o:</small>
                                                                        <strong>
                                                                            <%= new
                                                                                Date(product.createdAt).toLocaleString('vi-VN')
                                                                                %>
                                                                        </strong>
                                                                    </div>

                                                                    <div class="mb-2">
                                                                        <small class="text-muted d-block">C·∫≠p nh·∫≠t l·∫ßn
                                                                            cu·ªëi:</small>
                                                                        <strong>
                                                                            <%= new
                                                                                Date(product.updatedAt).toLocaleString('vi-VN')
                                                                                %>
                                                                        </strong>
                                                                    </div>

                                                                    <div class="mb-2">
                                                                        <small class="text-muted d-block">S·ªë ·∫£nh hi·ªán
                                                                            t·∫°i:</small>
                                                                        <span class="badge bg-label-info">
                                                                            <%= product.images ? product.images.length :
                                                                                0 %> ·∫£nh
                                                                        </span>
                                                                    </div>

                                                                    <div class="mb-0">
                                                                        <small class="text-muted d-block">Danh
                                                                            m·ª•c:</small>
                                                                        <span class="badge bg-label-primary">
                                                                            <%= product.category ? product.category.name
                                                                                : 'N/A' %>
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- H∆∞·ªõng d·∫´n -->
                                                            <div class="card bg-light">
                                                                <div class="card-body">
                                                                    <h5 class="card-title">
                                                                        <i class="bx bx-help-circle text-primary"></i>
                                                                        H∆∞·ªõng d·∫´n
                                                                    </h5>
                                                                    <hr>

                                                                    <div class="mb-3">
                                                                        <h6 class="text-primary">
                                                                            <i class="bx bx-chevron-right"></i> X√≥a ·∫£nh
                                                                        </h6>
                                                                        <p class="small text-muted mb-0">
                                                                            T√≠ch ch·ªçn ·∫£nh c·∫ßn x√≥a, sau ƒë√≥ nh·∫•n "C·∫≠p nh·∫≠t
                                                                            s·∫£n ph·∫©m"
                                                                        </p>
                                                                    </div>

                                                                    <div class="mb-3">
                                                                        <h6 class="text-primary">
                                                                            <i class="bx bx-chevron-right"></i> Th√™m ·∫£nh
                                                                        </h6>
                                                                        <p class="small text-muted mb-0">
                                                                            ·∫¢nh m·ªõi s·∫Ω ƒë∆∞·ª£c th√™m v√†o cu·ªëi danh s√°ch ·∫£nh
                                                                            hi·ªán t·∫°i
                                                                        </p>
                                                                    </div>

                                                                    <div class="mb-0">
                                                                        <h6 class="text-primary">
                                                                            <i class="bx bx-chevron-right"></i> X√≥a s·∫£n
                                                                            ph·∫©m
                                                                        </h6>
                                                                        <p class="small text-muted mb-0">
                                                                            S·ª≠ d·ª•ng n√∫t "X√≥a s·∫£n ph·∫©m" b√™n d∆∞·ªõi. Thao
                                                                            t√°c kh√¥ng th·ªÉ ho√†n t√°c.
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Buttons -->
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <div class="card">
                                                                <div
                                                                    class="card-body d-flex justify-content-between align-items-center">
                                                                    <div>
                                                                        <button type="submit" class="btn btn-primary">
                                                                            <i class="bx bx-save me-1"></i> C·∫≠p nh·∫≠t s·∫£n
                                                                            ph·∫©m
                                                                        </button>
                                                                        <a href="/admin/products"
                                                                            class="btn btn-outline-secondary">
                                                                            <i class="bx bx-x me-1"></i> H·ªßy
                                                                        </a>
                                                                    </div>
                                                                    <button type="button" class="btn btn-outline-danger"
                                                                        onclick="confirmDelete()">
                                                                        <i class="bx bx-trash me-1"></i> X√≥a s·∫£n ph·∫©m
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                            </div>
                        </div>
                </div>
        </div>
    </div>

    <%- include('../partials/admin/scripts') %>

        <script>
            // Preview ·∫£nh m·ªõi khi ch·ªçn file
            document.getElementById('productImages').addEventListener('change', function (e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = '';

                const files = Array.from(e.target.files);

                if (files.length > 10) {
                    alert('Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 10 ·∫£nh!');
                    this.value = '';
                    return;
                }

                files.forEach((file, index) => {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File ' + file.name + ' qu√° l·ªõn (>5MB)!');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const col = document.createElement('div');
                        col.className = 'col-md-3';
                        col.innerHTML = `
                        <div class="card">
                            <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;" />
                            <div class="card-body p-2 text-center">
                                <small class="text-success">‚ú® ·∫¢nh m·ªõi ${index + 1}</small>
                            </div>
                        </div>
                    `;
                        preview.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                });
            });

            // Validate form
            document.getElementById('editProductForm').addEventListener('submit', function (e) {
                const name = document.getElementById('productName').value.trim();
                const price = document.getElementById('productPrice').value;
                const category = document.getElementById('productCategory').value;
                const description = document.getElementById('productDesc').value.trim();

                if (!name || !price || !category || !description) {
                    e.preventDefault();
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                    return false;
                }

                if (parseFloat(price) < 0) {
                    e.preventDefault();
                    alert('Gi√° ph·∫£i l√† s·ªë d∆∞∆°ng!');
                    return false;
                }

                return true;
            });

            // X√°c nh·∫≠n x√≥a s·∫£n ph·∫©m
            function confirmDelete() {
                const productId = '<%= product._id %>';
                const productName = '<%= product.name %>';

                if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m "${productName}"?\n\nThao t√°c n√†y s·∫Ω x√≥a c·∫£ h√¨nh ·∫£nh v√† kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                    fetch(`/admin/products/delete/${productId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('X√≥a s·∫£n ph·∫©m th√†nh c√¥ng!');
                                window.location.href = '/admin/products';
                            } else {
                                alert('C√≥ l·ªói x·∫£y ra: ' + data.message);
                            }
                        })
                        .catch(error => {
                            alert('C√≥ l·ªói x·∫£y ra khi x√≥a s·∫£n ph·∫©m!');
                            console.error(error);
                        });
                }
            }
        </script>
</body>

</html>